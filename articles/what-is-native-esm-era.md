---
title: "Native ESM時代とはなにか"
emoji: "🧯"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ecmascript"]
published: false
---

最近の日本のフロントエンド界隈では「Native ESM時代」という言葉が聞こえてきます。Native ESM時代におけるビルドツールがどうなるかといったことが主な話題です。

個人的には面白い概念なので流行ってほしいと思い、Native ESM時代とは何かを解説する基礎的な資料を用意しました。

::: message
「Native ESM時代」が何を指すのかは人によって異なる可能性があります。この記事で説明するのは筆者の考えです。ご了承ください。
:::

## そもそもNative ESMとは

Native ESMとは、**ES Modules**のことです。つまり、ECMAScript仕様の一部として定義されたモジュールシステムを指します。現在、モダンな部類のフロントエンド開発において広く用いられている、`import`宣言でインポートし`export`宣言でエクスポートするのがES Modulesです。

::: message
以降、この記事では開発にES Modulesを使うようなモダンな部類のフロントエンド開発を指して単に「フロントエンド開発」という言葉を用います。
:::

## Native ESM時代とは

Native ESM時代というのは、**ビルド後にもES Modulesが利用されるようになった時代**です。

というのも、現在のフロントエンド開発ではソースコードをそのまま配布するのではなく、ビルドが必要です。ブラウザはビルドによって得られた成果物を読み込みます。ビルドのステップを担当するツールとして、Babel, esbuild, Webpackなどに代表されるツールたちが存在します。

現在主流の方法では、ビルド時に、バンドラと呼ばれるツールによって`import`・`export`で繋がった複数のJavaScriptファイルたちが一つのJavaScriptにまとめられます[^note_code_splitting]。これが成果物であり、ブラウザは1つにまとめられたJavaScriptファイルを読み込みます。ファイルが1つであるということは、もはや他のファイルを読み込む必要がないということです。つまり、ビルド前にES Modulesを利用していたとしても、ビルド後のJavaScriptではもはやES Modulesが使われません[^note_module_nomodule]。

[^note_code_splitting]: Code splittingと呼ばれる技法によって成果物が一つではなく複数になることもありますが、この記事では簡単のために説明を省略しています。
[^note_module_nomodule]: module-nomoduleパターンなどを介して使われていることもありますが、それは本記事のトピックとはあまり関係ありません。

この状況を破り、ビルド後の成果物にもES Modulesの利用が含まれる（言い換えれば、ビルド後の成果物が複数ファイル（モジュール）から成る）ようにしようというのがNative ESM時代の考え方です。

Native ESM時代には二段階があると考えられます。すなわち、開発ビルドでのみES Modulesが用いられて本番ビルドでは従来通りという段階と、開発ビルドでも本番ビルドでもES Modulesが用いられるという段階です。もちろん、前者のほうが先に到来するでしょう。また、前者については関連ツールの発展により既に来ているとも考えられます。以下の記事が参考になります。

https://zenn.dev/mizchi/articles/native-esm-age

## Native ESM時代に何が解決されるのか

次に、なぜNative ESM時代に移行する必要があるのか、言い換えれば旧来のやり方にどのような問題があり、Native ESM時代ではそれがどう解決されるのかを説明します。

問題は2つに大別されます。すなわち、**ビルドパフォーマンスの問題**と**本番パフォーマンスの問題**です。字面から察せられるように、前者は開発ビルドにも本番ビルドにも関わる話で、後者は本番ビルドにのみ関わる話です。前者のみを解決した状態が開発環境にNative ESM時代が到来した状態で、後者も解決されることで完全なNative ESM時代となります。この記事では、前者を**開発Native ESM時代**、後者を**本番Native ESM時代**と呼びましょう。

### ビルドパフォーマンスの問題

まず、ビルドパフォーマンスの問題を見ます。今回特に関連するのは、ビルドのうち、バンドラ（複数JavaScriptファイル間の`import`・`export`を解析して1つのJavaScriptにまとめるツール[^note_esbuild]）が担当する部分です。

端的に言えば、バンドルという工程それ自体が遅いです。バンドルという工程では、（とてもざっくりと言えば）複数のJavaScriptコードを1つの大きなコードに合体させて、うまく動くように多少変形させたり辻褄を合わせるランタイムのコードを追加したりすることです。アプリ全体の内容を含む大きなコードを生成するということは、アプリが大きくなるほど必然的に遅くなります。

また、とくに開発環境においては、ファイルを変更して保存するたびにすぐに再バンドルする運用が主流です。これは、Hot Module Replacementという機能を通して変更の影響を即座にブラウザ上に反映できるようにすることで、アプリ開発を高速化する仕組みです。

しょっちゅうバンドルをするということは、バンドルが遅いことが開発効率の低下に直結するということです。これがビルドパフォーマンスの問題です。再バンドルに当たってなるべく無駄な仕事を減らす努力はバンドラとしても行なっていますが、バンドルに時間がかかってストレスを感じることが少なくないというのが現状だと思います。また、再バンドルに備えてメモリに多量のデータをキャッシュする必要が生じるなど別の問題も起こります。

[^note_esbuild]: esbuildのように、バンドルだけに留まらないいくつかのビルドステップをまとめて行うことで高速化を図るツールもあります。むしろ、速さが求められるこれからの時代はそれが主流なのかもしれません。

（開発）Native ESM時代における解決策は、**そもそもバンドルをしない**ことです。つまり、ソースファイルに`import`や`export`があれば、それをそのままブラウザに読み込ませるということです（ソースファイルをブラウザに送る際に`import`先を必要に応じて調整する程度の変更はバンドラ（もはやバンドラと呼ぶべきではなさそうですが）が行います）。